{% extends "dashboard/base.html" %}
{% block content %}

<h2>{{ term }}</h2>

<div style="display:flex; gap:10px; align-items:center; margin: 10px 0 16px;">
  <div>
    <strong>{{ term }}</strong>
    <button type="button" onclick="openAI()">AI 분석</button>
  </div>

  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <label for="geoSelect">Geo</label>
    <select id="geoSelect" onchange="onGeoChange(this.value)">
      <option value="ALL" {% if geo == "ALL" %}selected{% endif %}>All geos</option>
      {% for g in geo_list %}
        <option value="{{ g }}" {% if g == geo %}selected{% endif %}>{{ g }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
{{ events|json_script:"events-data" }}

<!-- ================= Trend Chart ================= -->
<div class="card" style="padding:12px; margin-bottom:12px;">
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
    <strong>Trend (Google Trends)</strong>
    <div style="margin-left:auto; display:flex; gap:6px;">
      <button type="button" onclick="loadSeries(14)">14d</button>
      <button type="button" onclick="loadSeries(30)">30d</button>
      <button type="button" onclick="loadSeries(90)">90d</button>
    </div>
  </div>

  <div id="seriesChart"
       data-term="{{ term|escapejs }}"
       data-geo="{{ geo|escapejs }}"
       style="height:360px;"></div>
</div>

<h3>Events</h3>
<div id="eventsTable"></div>

<!-- ================= AI Slide Panel ================= -->

<!-- Backdrop -->
<div id="aiPanelBackdrop"
     onclick="closeAI()"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.25);
       z-index:9998;
     ">
</div>

<!-- Slide Panel -->
<div id="aiPanel"
     style="
       display:none; 
       position:fixed;
       top:0;
       right:0;
       width:360px;
       height:100%;
       background:#fff;
       box-shadow:-2px 0 8px rgba(0,0,0,.15);
       padding:16px;
       overflow:auto;
       z-index:9999;
     ">
  <button onclick="closeAI()" style="float:right;">×</button>
  <h3>AI Analysis</h3>
  <div id="aiContent">Loading...</div>
  <hr>
  <button onclick="sendToSlack()">Slack로 보내기</button>
</div>

<script>
/* ================= Common ================= */
let currentDays = 90;
let aiAnalysisCache = null;

/* ================= Events Table ================= */
function refreshEventsTable() {
  const el = document.getElementById("seriesChart");
  const term = el.dataset.term;
  const geo = el.dataset.geo;

  const url = `/events-table/?term=${encodeURIComponent(term)}&geo=${encodeURIComponent(geo)}&days=${currentDays}`;
  htmx.ajax("GET", url, { target: "#eventsTable", swap: "innerHTML" });
}

/* ================= Geo / Period ================= */
function onGeoChange(newGeo) {
  const el = document.getElementById("seriesChart");
  el.dataset.geo = newGeo;
  loadSeries(currentDays);
  refreshEventsTable();
}

function loadSeries(days) {
  currentDays = days;
  renderChart();
  refreshEventsTable();
}

/* ================= Chart ================= */
function getEvents() {
  const el = document.getElementById("events-data");
  return el ? JSON.parse(el.textContent) : [];
}

async function renderChart() {
  const el = document.getElementById("seriesChart");
  const term = el.dataset.term;
  const geo = el.dataset.geo;

  if (geo === "ALL") {
    const res = await fetch(`/api/term-series-all-geo/?term=${encodeURIComponent(term)}&days=${currentDays}`);
    const data = await res.json();

    const lines = data.traces.map(t => ({
      x: t.x, y: t.y, type:"scatter", mode:"lines", hoverinfo:"skip"
    }));

    const events = getEvents().filter(e => e.severity !== "NONE");
    const seriesMap = new Map();
    data.traces.forEach(t => {
      const m = new Map();
      t.x.forEach((d,i)=>m.set(d,t.y[i]));
      seriesMap.set(t.geo,m);
    });

    const dots = [];
    events.forEach(e => {
      const m = seriesMap.get(e.geo);
      if (!m) return;
      const y = m.get(e.date);
      if (y === undefined) return;
      dots.push({
        x:[e.date], y:[y],
        type:"scatter", mode:"markers",
        marker:{size:10},
        customdata:[e.severity],
        hovertemplate:"<b>%{x}</b><br>%{customdata}<extra></extra>",
        showlegend:false
      });
    });

    Plotly.newPlot(el, [...lines, ...dots], {
      hovermode:"x unified", 
      showlegend: false,
      yaxis: {
        rangemode: "tozero" // y축이 반드시 0을 포함하도록 설정
      }
    }, {responsive:true});
    return;
  }

  const res = await fetch(`/api/term-series/?term=${encodeURIComponent(term)}&geo=${geo}&days=${currentDays}`);
  const data = await res.json();

  const base = {
    x:data.x, y:data.y, type:"scatter", mode:"lines", hoverinfo:"skip"
  };

  const map = new Map(data.x.map((d,i)=>[d,data.y[i]]));
  const ev = getEvents().filter(e=>e.geo===geo && e.severity!=="NONE");

  const dots = {
    x:[], y:[], type:"scatter", mode:"markers", marker:{size:10},
    customdata:[], hovertemplate:"<b>%{x}</b><br>%{customdata}<extra></extra>",
    showlegend:false
  };

  ev.forEach(e=>{
    const y = map.get(e.date);
    if (y!==undefined) {
      dots.x.push(e.date);
      dots.y.push(y);
      dots.customdata.push(e.severity);
    }
  });

  Plotly.newPlot(el, [base, dots], {
    hovermode: "x unified",
    showlegend: false,
    yaxis: {
      rangemode: "tozero" // y축이 반드시 0을 포함하도록 설정
    }
  }, {responsive: true});
}

/* ================= AI Panel ================= */
function openAI() {
  const term = "{{ term|escapejs }}";
  const geo = document.getElementById("geoSelect")?.value || "ALL";

  //  보이게
  document.getElementById("aiPanel").style.display = "block";
  document.getElementById("aiPanelBackdrop").style.display = "block";

  document.getElementById("aiContent").innerHTML = "AI 분석 중...";
  
  fetch(`{% url 'api_term_ai' %}?term=${encodeURIComponent(term)}&geo=${encodeURIComponent(geo)}`)
}

function closeAI() {
  //  다시 완전 비노출
  document.getElementById("aiPanel").style.display = "none";
  document.getElementById("aiPanelBackdrop").style.display = "none";
}


function sendToSlack() {
  if (!aiAnalysisCache) return alert("분석 결과 없음");

  fetch("/api/term-ai-slack/", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      term:"{{ term }}",
      geo:document.getElementById("geoSelect")?.value || "ALL",
      analysis:aiAnalysisCache
    })
  }).then(()=>alert("Slack 전송 완료"));
}

/* ================= Init ================= */
loadSeries(90);
refreshEventsTable();
</script>

{% endblock %}
