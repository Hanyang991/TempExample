{% extends "dashboard/base.html" %}
{% block content %}
<h2>{{ term }}</h2>
<div style="display:flex; gap:10px; align-items:center; margin: 10px 0 16px;">
  <div>
    <strong>{{ term }}</strong>
  </div>

  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <label for="geoSelect">Geo</label>
    <select id="geoSelect" onchange="onGeoChange(this.value)">
      <option value="ALL" {% if geo == "ALL" %}selected{% endif %}>All</option>
      {% for g in geo_list %}
        <option value="{{ g }}" {% if g == geo %}selected{% endif %}>{{ g }}</option>
      {% endfor %}
    </select>
  </div>
</div>
<!-- Plotly CDN: base.html에 넣어도 되고, 여기 넣어도 됨 -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
{{ events|json_script:"events-data" }}
<div class="card" style="padding:12px; margin-bottom:12px;">
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
    <strong>Trend (Google Trends)</strong>
    <div style="margin-left:auto; display:flex; gap:6px;">
      <button type="button" onclick="loadSeries(14)">14d</button>
      <button type="button" onclick="loadSeries(30)">30d</button>
      <button type="button" onclick="loadSeries(90)">90d</button>
    </div>
  </div>

  <!-- ✅ id는 하나만, data-*도 여기 달기 -->
  <div id="seriesChart"
    data-term="{{ term|escapejs }}"
    data-geo="{{ geo|default:''|escapejs }}"
    style="height:360px;">
  </div>
</div>

<h3>Events</h3>
<table>
  <tr><th>date</th><th>geo</th><th>z</th><th>wow</th><th>severity</th></tr>
  {% for f in features %}
  <tr>
    <td>{{ f.as_of_date }}</td>
    <td>{{ f.geo }}</td>
    <td>{{ f.z_score|floatformat:2 }}</td>
    <td>{{ f.wow_change|floatformat:2 }}</td>
    <td>
      {% if f.z_score >= 2.5 %}<span class="pill">BREAKOUT</span>
      {% elif f.z_score >= 2.0 %}<span class="pill">RISING</span>
      {% elif f.z_score >= 1.0 %}<span class="pill">WATCH</span>
      {% else %}<span class="pill">NONE</span>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

<script>
  let currentDays = 90;

  function onGeoChange(newGeo) {
    const el = document.getElementById("seriesChart");
    el.dataset.geo = newGeo;
    loadSeries(currentDays);
  }

  function loadSeries(days) {
    currentDays = days;
    renderChart();
  }

  async function renderChart() {
    const el = document.getElementById("seriesChart");
    const term = el.dataset.term;
    const geo = el.dataset.geo;

    // ===== ALL geos =====
    if (geo === "ALL") {
      const url = `/api/term-series-all-geo/?term=${encodeURIComponent(term)}&days=${currentDays}`;
      const res = await fetch(url);
      const data = await res.json();

      const traces = data.traces.map(t => ({
        x: t.x,
        y: t.y,
        type: "scatter",
        mode: "lines",
        name: t.geo,
      }));

      Plotly.newPlot(el, traces, {
        margin: {t: 20, r: 10, b: 40, l: 50},
        xaxis: {title: "Date"},
        yaxis: {title: "Interest"},
        hovermode: "x unified",
        showlegend: false,
      }, {responsive: true});

      return;
    }

    // ===== Single geo =====
    const url = `/api/term-series/?term=${encodeURIComponent(term)}&geo=${encodeURIComponent(geo)}&days=${currentDays}`;
    const res = await fetch(url);
    const data = await res.json();

    const seriesTrace = {
      x: data.x,
      y: data.y,
      type: "scatter",
      mode: "lines",
    };

    // 이벤트 점
    const valueByDate = new Map();
    for (let i = 0; i < data.x.length; i++) {
      valueByDate.set(data.x[i], data.y[i]);
    }

    const eventsEl = document.getElementById("events-data");
    const events = eventsEl
      ? JSON.parse(eventsEl.textContent).filter(
          e => e.severity !== "NONE" && e.geo === geo
        )
      : [];

    const evX = [];
    const evY = [];
    const evText = [];

    for (const e of events) {
      const y = valueByDate.get(e.date);
      if (y === undefined) continue;
      evX.push(e.date);
      evY.push(y);
      evText.push(`${e.severity}<br>z=${e.z.toFixed(2)}<br>wow=${e.wow.toFixed(2)}`);
    }

    const eventTrace = {
      x: evX,
      y: evY,
      type: "scatter",
      mode: "markers",
      marker: { size: 10 },
      showlegend: false,
      hovertemplate: "%{text}<extra></extra>",
    };

    Plotly.newPlot(el, [seriesTrace, eventTrace], {
      margin: {t: 20, r: 10, b: 40, l: 50},
      xaxis: {title: "Date"},
      yaxis: {title: "Interest"},
      hovermode: "x unified",
      showlegend: false,
    }, {responsive: true});
  }

  loadSeries(90);

</script>



{% endblock %}
