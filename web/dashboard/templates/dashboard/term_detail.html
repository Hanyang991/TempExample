{% extends "dashboard/base.html" %}
{% block content %}
<h2>{{ term }}</h2>
<div style="display:flex; gap:10px; align-items:center; margin: 10px 0 16px;">
  <div>
    <strong>{{ term }}</strong>
  </div>

  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <label for="geoSelect">Geo</label>
    <select id="geoSelect" onchange="onGeoChange(this.value)">
      {% for g in geo_list %}
        <option value="{{ g }}" {% if g == geo %}selected{% endif %}>{{ g }}</option>
      {% endfor %}
    </select>

    <button type="button" onclick="toggleAllGeo()">All geos</button>
  </div>
</div>
<!-- Plotly CDN: base.html에 넣어도 되고, 여기 넣어도 됨 -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<div class="card" style="padding:12px; margin-bottom:12px;">
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
    <strong>Trend (Google Trends)</strong>
    <div style="margin-left:auto; display:flex; gap:6px;">
      <button type="button" onclick="loadSeries(14)">14d</button>
      <button type="button" onclick="loadSeries(30)">30d</button>
      <button type="button" onclick="loadSeries(90)">90d</button>
    </div>
  </div>

  <!-- ✅ id는 하나만, data-*도 여기 달기 -->
  <div id="seriesChart"
    data-term="{{ term|escapejs }}"
    data-geo="{{ geo|default:''|escapejs }}"
    style="height:360px;">
  </div>
</div>

<h3>Events</h3>
<table>
  <tr><th>date</th><th>geo</th><th>z</th><th>wow</th><th>severity</th></tr>
  {% for f in features %}
  <tr>
    <td>{{ f.as_of_date }}</td>
    <td>{{ f.geo }}</td>
    <td>{{ f.z_score|floatformat:2 }}</td>
    <td>{{ f.wow_change|floatformat:2 }}</td>
    <td>
      {% if f.z_score >= 2.5 %}<span class="pill">BREAKOUT</span>
      {% elif f.z_score >= 2.0 %}<span class="pill">RISING</span>
      {% elif f.z_score >= 1.0 %}<span class="pill">WATCH</span>
      {% else %}<span class="pill">NONE</span>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

<script>
  let currentDays = 90;
  let mode = "single"; // "single" | "all"

  function onGeoChange(newGeo) {
    const el = document.getElementById("seriesChart");
    el.dataset.geo = newGeo;
    mode = "single";
    render();
  }

  function toggleAllGeo() {
    mode = (mode === "all") ? "single" : "all";
    render();
  }

  async function render() {
    const el = document.getElementById("seriesChart");
    const term = el.dataset.term;
    const geo = el.dataset.geo;

    if (mode === "all") {
      const url = `/api/term-series-all-geo/?term=${encodeURIComponent(term)}&days=${currentDays}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!res.ok || data.error) {
        el.innerHTML = `<div style="padding:12px;color:#b00">API error: ${res.status} ${data.error || ""}</div>`;
        return;
      }

      const traces = data.traces.map(t => ({
        x: t.x, y: t.y, type: "scatter", mode: "lines", name: t.name,
      }));

      Plotly.newPlot(el, traces, {
        margin: {t: 20, r: 10, b: 40, l: 50},
        xaxis: {title: "Date"},
        yaxis: {title: "Interest"},
        hovermode: "x unified",
        legend: {orientation: "h"},
      }, {responsive: true});

    } else {
      const url = `/api/term-series/?term=${encodeURIComponent(term)}&geo=${encodeURIComponent(geo)}&days=${currentDays}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!res.ok || data.error) {
        el.innerHTML = `<div style="padding:12px;color:#b00">API error: ${res.status} ${data.error || ""}</div>`;
        return;
      }

      Plotly.newPlot(el, [{
        x: data.x, y: data.y, type: "scatter", mode: "lines",
        name: `${data.term} (${data.geo})`,
      }], {
        margin: {t: 20, r: 10, b: 40, l: 50},
        xaxis: {title: "Date"},
        yaxis: {title: "Interest"},
        hovermode: "x unified",
      }, {responsive: true});
    }
  }

  function loadSeries(days) {
    currentDays = days;
    render();
  }

  loadSeries(90);
</script>


{% endblock %}
